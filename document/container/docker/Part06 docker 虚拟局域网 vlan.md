
# docker 虚拟局域网 vlan

  * docker 两种 vlan 网络：ipvlan、macvlan

        +-----------------------+-----------------------+------------------------+-----------------------------------------------------------------------------+
        |        网络类型       |       跨主机访问       |   CentOS内核要求      |                                 特点                                          |
        +-----------------------+-----------------------+------------------------+-----------------------------------------------------------------------------+
        |       IPvlan L2       |          是           |         4.2+           | 容器具有相同 mac 和不同 IP，容器之间互通，无法直连宿主机，手动分配 IP 地址      |
        +-----------------------+-----------------------+------------------------+-----------------------------------------------------------------------------+
        |  IPvlan L2 + 802.1Q   |          是           |         4.2+           | 在 L2 模式上，容器进行分组隔离，不同分组的容器不允许互相访问                    |
        +-----------------------+-----------------------+------------------------+-----------------------------------------------------------------------------+
        |       IPvlan L3       |          否           |         4.2+           | 不允许广播流量，容器不能跨主机访问                                             |
        +-----------------------+-----------------------+------------------------+-----------------------------------------------------------------------------+
        |        macvlan        |          是           |         3.9+           | 直接连接到物理网络实现，隔离弱化，容器之间互通，无法直连宿主机，手动分配 IP 地址 |
        +-----------------------+-----------------------+------------------------+-----------------------------------------------------------------------------+

  * 注意，可以让容器连接多个不同类型的网络，比如 bridge 类型，让容器与宿主机可以通信：

        # 先启动容器，容器启动时指定 vlan 网络
        # ...

        # 容器连接 bridge 网络
        docker network connect bridge centos

        # 容器断开 bridge 网络
        docker network disconnect bridge nginx

### IPvlan L2

  * 容器 ipvlan 网络规划：

        IPvlan：IP 10.1.0.0/16 Gateway 10.1.0.1

        第一台服务器分配IP：10.1.1.0/24

        第二台服务器分配IP：10.1.2.0/24

  * 两台服务器配置 docker ipvlan l2 模式网卡，输入命令：

        docker network create \
            -d ipvlan \
            --subnet=10.1.0.0/16 \
            --gateway=10.1.0.1 \
            -o ipvlan_mode=l2 \
            -o parent=ens33 \
            ipvlanl2

        docker network ls

        ->
        +--------------+------------------+---------+-------+
        |  NETWORK ID  |      NAME        |  DRIVER | SCOPE |
        +--------------+------------------+---------+-------+
        | 5217f2232b46 |  bridge          | bridge  | local |
        +--------------+------------------+---------+-------+
        | 1f514d9ef86b |  host            | host    | local |
        +--------------+------------------+---------+-------+
        | b020119e4d9e |  ipvlanl2        | ipvlan  | global|
        +--------------+------------------+---------+-------+
        | 7c9f12689eb8 |  none            | null    | local |
        +--------------+------------------+---------+-------+

  * 第一台服务器运行 centos 和 nginx 容器，输入命令：

        docker pull centos

        docker pull nginx

        docker run -d -it --net=ipvlanl2 --name centos --ip 10.1.1.1 centos /usr/sbin/init

        docker run -d -it --net=ipvlanl2 --name nginx -p 80:80 --ip 10.1.1.2 nginx

        docker ps

  * 第二台服务器运行 centos 和 nginx 容器，输入命令：

        docker pull centos

        docker pull nginx

        docker run -d -it --net=ipvlanl2 --name centos --ip 10.1.2.1 centos /usr/sbin/init

        docker run -d -it --net=ipvlanl2 --name nginx -p 80:80 --ip 10.1.2.2 nginx

        docker ps

  * 两台服务器查看容器网络，输入命令：

        docker network inspect ipvlanl2

        -> 第一台服务器输出
        +----------+------------------+-----------------+-------------------+----------------+-------------------+
        | Network  |      Subnet      |     Gateway     |     container     |   IPv4Address  |     MacAddress    |
        +----------+------------------+-----------------+-------------------+----------------+-------------------+
        |          |                  |                 |      centos       |   10.1.1.1/16  |                   |
        | ipvlanl2 |   10.1.0.0/16    |     10.1.0.1    +-------------------+----------------+-------------------+
        |          |                  |                 |       nginx       |   10.1.1.2/16  |                   |
        +----------+------------------+-----------------+-------------------+----------------+-------------------+

        -> 第二台服务器输出
        +----------+------------------+-----------------+-------------------+----------------+-------------------+
        | Network  |      Subnet      |     Gateway     |     container     |   IPv4Address  |     MacAddress    |
        +----------+------------------+-----------------+-------------------+----------------+-------------------+
        |          |                  |                 |      centos       |   10.1.2.1/16  |                   |
        | ipvlanl2 |   10.1.0.0/16    |     10.1.0.1    +-------------------+----------------+-------------------+
        |          |                  |                 |       nginx       |   10.1.2.2/16  |                   |
        +----------+------------------+-----------------+-------------------+----------------+-------------------+

  * 以上配置成功，四个容器的IP地址分别为：

        10.1.1.1    10.1.1.2

        10.1.2.1    10.1.2.2

  * 容器可以 ping 本机容器，输入命令：

        docker exec -it centos ping 10.1.1.2

        ->

            64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=0.218 ms
            64 bytes from 10.1.1.2: icmp_seq=2 ttl=64 time=0.065 ms
            64 bytes from 10.1.1.2: icmp_seq=3 ttl=64 time=0.045 ms
            3 packets transmitted, 3 received, 0% packet loss, time 2055ms

  * 容器可以 ping 跨主机容器，输入命令：

        docker exec -it centos ping 10.1.2.1

        ->

            64 bytes from 10.1.2.1: icmp_seq=1 ttl=64 time=0.651 ms
            64 bytes from 10.1.2.1: icmp_seq=2 ttl=64 time=0.330 ms
            64 bytes from 10.1.2.1: icmp_seq=3 ttl=64 time=0.437 ms
            3 packets transmitted, 3 received, 0% packet loss, time 2038ms

  * 容器不能 ping 宿主机，输入命令：

        docker exec -it centos ping 192.168.140.201

        ->

            From 10.1.1.1 icmp_seq=1 Destination Host Unreachable
            From 10.1.1.1 icmp_seq=2 Destination Host Unreachable
            From 10.1.1.1 icmp_seq=3 Destination Host Unreachable
            4 packets transmitted, 0 received, +3 errors, 100% packet loss, time 3070ms

  * 容器不能 ping 互联网，输入命令：

        docker exec -it centos ping www.baidu.com

        ->
            ping: www.baidu.com: Name or service not known

  * 宿主机不能 ping 容器，输入命令：

        ping 10.1.1.1

        ->
            46 packets transmitted, 0 received, 100% packet loss, time 46082ms

  * 宿主机不能访问 nginx，输入命令：

        curl http://192.168.140.200

        ->
            curl: (7) Failed connect to 192.168.140.200:80; Connection refused

### IPvlan L2 + 802.1Q

  * 容器 ipvlan 网络规划：

        IPvlan：IP 10.1.0.0/16 Gateway 10.1.0.1

        第一台服务器划入分组一，IP：10.1.10.1/24

        第二台服务器划入分组二，IP：10.1.20.1/24

  * 第一台服务器创建 ipvlan l2 网络，并运行两个 centos 容器，输入命令：

        docker network  create  -d ipvlan \
            --subnet=10.1.0.0/16 \
            --gateway=10.1.0.1  \
            -o ipvlan_mode=l2 \
            -o parent=ens33.10 \
            ipvlanl2-10

        docker run -d -it --net ipvlanl2-10 --ip 10.1.10.1 --name centos1 centos

        docker run -d -it --net ipvlanl2-10 --ip 10.1.10.2 --name centos2 centos

  * 第二台服务器创建 ipvlan l2 网络，并运行两个 centos 容器，输入命令：

        docker network  create  -d ipvlan  \
            --subnet=10.1.0.0/16 \
            --gateway=10.1.0.1  \
            -o ipvlan_mode=l2 \
            -o parent=ens33.20 \
            ipvlanl2-20

        docker run -d -it --net ipvlanl2-20 --ip 10.1.20.1 --name centos1 centos

        docker run -d -it --net ipvlanl2-20 --ip 10.1.20.2 --name centos2 centos

  * 第一台服务器查询本机网络和容器网络，输入命令：

        ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |      master    |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        |    ens33        | 192.168.140.200/24 | 192.168.140.255 | 00:0c:29:d7:d4:c3 |      global    |                |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:e1:00:76:b7 |      global    |                |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        | ens33.10@ens33  |                    |                 | 00:0c:29:d7:d4:c3 |       link     |     ens33      |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+

        docker exec -it centos1 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   eth0@if21     |   10.1.10.1/16     |  10.1.255.255   | 00:0c:29:d7:d4:c3 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker exec -it centos2 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   eth0@if21     |   10.1.10.2/16     |  10.1.255.255   | 00:0c:29:d7:d4:c3 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker network ls

        ->
        +--------------+------------------+---------+-------+
        |  NETWORK ID  |      NAME        |  DRIVER | SCOPE |
        +--------------+------------------+---------+-------+
        | 8e5fcb471315 |  bridge          | bridge  | local |
        +--------------+------------------+---------+-------+
        | ee8fd6692cdd |  host            | host    | local |
        +--------------+------------------+---------+-------+
        | b497f47bac43 |  ipvlanl2-10     | ipvlan  | local |
        +--------------+------------------+---------+-------+
        | adf9c8bdb9dc |  none            | null    | local |
        +--------------+------------------+---------+-------+

        docker network inspect ipvlanl2-10

        ->
        +-----------+------------------+-----------------+-------------------+----------------+-------------------+
        | Network   |      Subnet      |     Gateway     |     container     |   IPv4Address  |     MacAddress    |
        +-----------+------------------+-----------------+-------------------+----------------+-------------------+
        |           |                  |                 |      centos1      |  10.1.10.1/16  |                   |
        |ipvlanl2-10|   10.1.0.0/16    |     10.1.0.1    +-------------------+----------------+-------------------+
        |           |                  |                 |      centos2      |  10.1.10.2/16  |                   |
        +-----------+------------------+-----------------+-------------------+----------------+-------------------+

  * 第二台服务器查询本机网络和容器网络，输入命令：

        ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |      master    |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |                |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:00:31:35:46 |      global    |                |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        | ens33.20@ens33  |                    |                 | 00:0c:29:92:0a:f0 |       link     |     ens33      |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+

        docker exec -it centos1 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   eth0@if24     |   10.1.20.1/16     |  10.1.255.255   | 00:0c:29:92:0a:f0 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker exec -it centos2 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   eth0@if24     |   10.1.20.2/16     |  10.1.255.255   | 00:0c:29:92:0a:f0 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker network ls

        ->
        +--------------+------------------+---------+-------+
        |  NETWORK ID  |      NAME        |  DRIVER | SCOPE |
        +--------------+------------------+---------+-------+
        | ddb8073f173a |  bridge          | bridge  | local |
        +--------------+------------------+---------+-------+
        | 1f514d9ef86b |  host            | host    | local |
        +--------------+------------------+---------+-------+
        | 2d41c9884346 |  ipvlanl2-20     | ipvlan  | local |
        +--------------+------------------+---------+-------+
        | 7c9f12689eb8 |  none            | null    | local |
        +--------------+------------------+---------+-------+

        docker network inspect ipvlanl2-20

        ->
        +-----------+------------------+-----------------+-------------------+----------------+-------------------+
        | Network   |      Subnet      |     Gateway     |     container     |   IPv4Address  |     MacAddress    |
        +-----------+------------------+-----------------+-------------------+----------------+-------------------+
        |           |                  |                 |      centos1      |  10.1.20.1/16  |                   |
        |ipvlanl2-10|   10.1.0.0/16    |     10.1.0.1    +-------------------+----------------+-------------------+
        |           |                  |                 |      centos2      |  10.1.20.2/16  |                   |
        +-----------+------------------+-----------------+-------------------+----------------+-------------------+

  * 容器同分组可以 ping，第二台宿主机输入命令：

        docker exec -it centos1 ping 10.1.20.2

        ->

            64 bytes from 10.1.20.2: icmp_seq=1 ttl=64 time=6.14 ms
            64 bytes from 10.1.20.2: icmp_seq=2 ttl=64 time=0.058 ms
            64 bytes from 10.1.20.2: icmp_seq=3 ttl=64 time=0.116 ms
            3 packets transmitted, 3 received, 0% packet loss, time 2042ms

  * 容器不能 ping 其他分组容器，第二台宿主机输入命令：

        docker exec -it centos1 ping 10.1.10.1

        ->

            From 10.1.20.1 icmp_seq=1 Destination Host Unreachable
            From 10.1.20.1 icmp_seq=2 Destination Host Unreachable
            From 10.1.20.1 icmp_seq=3 Destination Host Unreachable
            5 packets transmitted, 0 received, +3 errors, 100% packet loss, time 4131ms

#### IPvlan L3

  * 宿主机创建 ipvlan l3 网卡，并运行 centos 容器，输入命令：

        docker network  create  -d ipvlan \
            --subnet=10.100.0.0/16 \
            --subnet=172.100.0.0/16 \
            -o ipvlan_mode=l3 \
            -o parent=ens33 \
            ipvlanl3

        docker run -d -it --net ipvlanl3 --ip 10.100.1.2 --name centos1 centos

        docker run -d -it --net ipvlanl3 --ip 172.100.1.2 --name centos2 centos

  * 不同网段容器可以 ping，输入命令：

        docker exec -it centos1 ping 172.100.1.2

        ->

            64 bytes from 172.100.1.2: icmp_seq=1 ttl=64 time=0.046 ms
            64 bytes from 172.100.1.2: icmp_seq=2 ttl=64 time=0.071 ms
            64 bytes from 172.100.1.2: icmp_seq=3 ttl=64 time=0.047 ms
            64 bytes from 172.100.1.2: icmp_seq=4 ttl=64 time=0.042 ms
            4 packets transmitted, 4 received, 0% packet loss, time 3114ms

#### macvlan

  * 第一台宿主机创建 macvlan 网卡，并运行 centos 容器，输入命令：

        docker network create -d macvlan --subnet=10.100.0.0/16 --gateway=10.100.0.1 -o parent=ens33 macvlan

        docker run -d -it --net macvlan --ip 10.100.1.1 --name centos1 centos

        docker run -d -it --net macvlan --ip 10.100.1.2 --name centos2 centos

  * 第二台宿主机创建 macvlan 网卡，并运行 centos 容器，输入命令：

        docker network create -d macvlan --subnet=10.100.0.0/16 --gateway=10.100.0.1 -o parent=ens33 macvlan

        docker run -d -it --net macvlan --ip 10.100.2.1 --name centos1 centos

        docker run -d -it --net macvlan --ip 10.100.2.2 --name centos2 centos

  * 第一台宿主机查看本机和容器网络，输入命令：

        ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |      master    |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        |    ens33        | 192.168.140.200/24 | 192.168.140.255 | 00:0c:29:d7:d4:c3 |      global    |                |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:f3:32:c2:79 |      global    |                |
        +-----------------+--------------------+-----------------+-------------------+----------------+----------------+

        docker exec -it centos1 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   eth0@if2      |   10.100.1.1/16    | 10.100.255.255  | 02:42:0a:64:01:01 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker exec -it centos2 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   eth0@if2      |   10.100.1.2/16    | 10.100.255.255  | 02:42:0a:64:01:02 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker network inspect macvlan

        ->
        +-----------+------------------+-----------------+-------------------+----------------+-------------------+
        | Network   |      Subnet      |     Gateway     |     container     |   IPv4Address  |     MacAddress    |
        +-----------+------------------+-----------------+-------------------+----------------+-------------------+
        |           |                  |                 |      centos1      | 10.100.1.1/16  | 02:42:0a:64:01:01 |
        |  macvlan  |  10.100.0.0/16   |   10.100.0.1    +-------------------+----------------+-------------------+
        |           |                  |                 |      centos2      | 10.100.1.2/16  | 02:42:0a:64:01:02 |
        +-----------+------------------+-----------------+-------------------+----------------+-------------------+

  * 第二台宿主机查看本机和容器网络，输入命令：

        ip addr

        ->
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
          |  interface      |      ipv4          |       brd       |       mac         |      scope     |      master    |
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
          |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |                |
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
          |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:9d:4a:ca:14 |      global    |                |
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+

        docker exec -it centos1 ip addr

        ->
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |   eth0@if2      |   10.100.2.1/16    | 10.100.255.255  | 02:42:0a:64:02:01 |      global    |             |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker exec -it centos2 ip addr

        ->
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |   eth0@if2      |   10.100.2.2/16    | 10.100.255.255  | 02:42:0a:64:02:02 |      global    |             |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker network inspect macvlan

        ->
          +-----------+------------------+-----------------+-------------------+----------------+-------------------+
          | Network   |      Subnet      |     Gateway     |     container     |   IPv4Address  |     MacAddress    |
          +-----------+------------------+-----------------+-------------------+----------------+-------------------+
          |           |                  |                 |      centos1      | 10.100.2.1/16  | 02:42:0a:64:02:01 |
          |  macvlan  |  10.100.0.0/16   |   10.100.0.1    +-------------------+----------------+-------------------+
          |           |                  |                 |      centos2      | 10.100.2.2/16  | 02:42:0a:64:02:02 |
          +-----------+------------------+-----------------+-------------------+----------------+-------------------+

  * 容器可以 ping 本机容器，输入命令：

        docker exec -it centos1 ping 10.100.1.2

        ->

            PING 10.100.1.2 (10.100.1.2) 56(84) bytes of data.
            64 bytes from 10.100.1.2: icmp_seq=1 ttl=64 time=0.315 ms
            64 bytes from 10.100.1.2: icmp_seq=2 ttl=64 time=0.069 ms
            64 bytes from 10.100.1.2: icmp_seq=3 ttl=64 time=0.109 ms
            3 packets transmitted, 3 received, 0% packet loss, time 2030ms

  * 容器可以 ping 跨主机容器，输入命令：

        docker exec -it centos1 ping 10.100.2.1

        ->

            PING 10.100.2.1 (10.100.2.1) 56(84) bytes of data.
            64 bytes from 10.100.2.1: icmp_seq=1 ttl=64 time=0.418 ms
            64 bytes from 10.100.2.1: icmp_seq=2 ttl=64 time=0.347 ms
            64 bytes from 10.100.2.1: icmp_seq=3 ttl=64 time=0.458 ms
            3 packets transmitted, 3 received, 0% packet loss, time 2030ms

  * 容器不能 ping 宿主机，输入命令：

        docker exec -it centos1 ping 192.168.140.200

        ->

            PING 192.168.140.200 (192.168.140.200) 56(84) bytes of data.
            From 10.100.1.1 icmp_seq=1 Destination Host Unreachable
            From 10.100.1.1 icmp_seq=2 Destination Host Unreachable
            From 10.100.1.1 icmp_seq=3 Destination Host Unreachable
            5 packets transmitted, 0 received, +3 errors, 100% packet loss, time 4103ms
