
# docker 基础网络 networks

  * 默认提供四种类型的网络：bridge、host、none、container

  * 桥接网络 bridge

        桥接网络是容器默认的网络模式，容器启动加上参数 --net=bridge 或者不指定 --net 参数

        桥接模式使用虚拟网络设备 veth-pair 技术处理容器的网络连接，此模式下容器不能跨主机访问，只适合单机运行多个 docker 容器

        注意，使用 docker network create -d bridge <NAME> 命令创建的网卡，也属于桥接网络

  * 共享主机网络 host

        共享主机网络，启动加上 --net=host 参数

        每个容器都使用宿主机的网卡，网络隔离性弱化，不建议 docker 使用

  * 无网络模式 none

        无网络模式，启动加上 --net=none 参数

        每个容器都只有本机回环网卡 lo，如果手动对容器进行网卡配置，无法与容器外进行网络通信

  * 共享容器网络 container

        共享容器网络，容器启动时加上 --net=container:<NAME> 参数，<NAME>为另一个运行中的容器名称

        容器共享另一个容器的网卡，网络状况决定于另一个容器启用的网络模式

### 桥接网络 bridge

  * 准备两台测试服务器(根据 Part1 配置好 docker)：

        192.168.140.201

        192.168.140.202

  * 宿主机查看本机网络，输入命令：

        ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:8c:5b:ba:0a |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        可以看到宿主机有两个网卡，一个安装虚拟机自带的网卡 ens33，另一个安装 docker 自动配置的网卡 docker0

  * 宿主机运行两个 centos 容器，输入命令：

        docker pull centos

        docker run -it -d --name centos1 centos /usr/sbin/init

        docker run -it -d --name centos2 centos /usr/sbin/init

        docker ps

  * 宿主机查看 centos 容器网络，输入命令：

        docker exec -it centos1 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    interface    |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    eth0@if10    |   172.17.0.2/16    |  172.17.255.255 | 02:42:ac:11:00:02 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker exec -it centos2 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    interface    |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    eth0@if12    |   172.17.0.3/16    |  172.17.255.255 | 02:42:ac:11:00:03 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

  * 宿主机查看本机网络，输入命令：

        ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:8c:5b:ba:0a |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        | veth39b574f@if9 |                    |                 | a6:71:00:00:19:72 |       link     |   docker0   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        | veth511496f@if11|                    |                 | 92:e2:26:2c:63:33 |       link     |   docker0   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

  * 宿主机查看 docker 网络，输入命令：

        docker network ls

        docker network inspect bridge

        ->
        +----------+------------------+-----------------+-------------------+----------------+-------------------+
        | Network  |      Subnet      |     Gateway     |     container     |   IPv4Address  |     MacAddress    |
        +----------+------------------+-----------------+-------------------+----------------+-------------------+
        |          |                  |                 |      centos1      |  172.17.0.2/16 | 02:42:ac:11:00:02 |
        |  bridge  |  172.17.0.0/16   |    172.17.0.1   +-------------------+----------------+-------------------+
        |          |                  |                 |      centos2      |  172.17.0.3/16 | 02:42:ac:11:00:03 |
        +----------+------------------+-----------------+-------------------+----------------+-------------------+

  * 整理以上网络情况，可以梳理出网络连接信息(宿主机网卡-宿主机veth网卡-容器网卡)：

        docker0 ---- veth04acfbc@if8  -------  eth0@if9

        docker0 ---- vethade2d2e@if10 -------  eth0@if11

  * 容器可以 ping 宿主机，输入命令：

        docker exec -it centos2 ping 192.168.140.201

        ->

            64 bytes from 192.168.140.201: icmp_seq=1 ttl=64 time=0.205 ms
            64 bytes from 192.168.140.201: icmp_seq=2 ttl=64 time=0.050 ms
            64 bytes from 192.168.140.201: icmp_seq=3 ttl=64 time=0.045 ms

            3 packets transmitted, 3 received, 0% packet loss, time 2000ms

  * 容器可以 ping 与宿主机同一局域网的主机，输入命令：

        docker exec -it centos2 ping 192.168.140.202

        ->

            64 bytes from 192.168.140.202: icmp_seq=1 ttl=63 time=0.981 ms
            64 bytes from 192.168.140.202: icmp_seq=2 ttl=63 time=0.308 ms
            64 bytes from 192.168.140.202: icmp_seq=3 ttl=63 time=0.283 ms

            3 packets transmitted, 3 received, 0% packet loss, time 2002ms

  * 容器可以 ping 宿主机能访问的互联网，输入命令：

        docker exec -it centos2 ping www.baidu.com

        ->

            64 bytes from 14.215.177.38 (14.215.177.38): icmp_seq=1 ttl=127 time=11.7 ms
            64 bytes from 14.215.177.38 (14.215.177.38): icmp_seq=2 ttl=127 time=10.3 ms
            64 bytes from 14.215.177.38 (14.215.177.38): icmp_seq=3 ttl=127 time=11.0 ms

            3 packets transmitted, 3 received, 0% packet loss, time 2004ms

  * 容器可以 ping 同一宿主机的其他容器，输入命令：

        docker exec -it centos2 ping 172.17.0.2

        ->

            64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.171 ms
            64 bytes from 172.17.0.2: icmp_seq=2 ttl=64 time=0.052 ms
            64 bytes from 172.17.0.2: icmp_seq=3 ttl=64 time=0.052 ms

            3 packets transmitted, 3 received, 0% packet loss, time 2000ms

  * 容器不能 ping 另一台宿主机的容器，输入命令：

        # 在另一台宿主机运行三个 centos 容器，其中一个 IP 地址为 172.17.0.3
        docker exec -it centos ping 172.17.0.3

        ->

            From 172.17.0.2 icmp_seq=1 Destination Host Unreachable
            From 172.17.0.2 icmp_seq=2 Destination Host Unreachable
            From 172.17.0.2 icmp_seq=3 Destination Host Unreachable
            From 172.17.0.2 icmp_seq=4 Destination Host Unreachable

            4 packets transmitted, 0 received, +4 errors, 100% packet loss, time 3000ms

  * 宿主机查看容器 centos2 网络，输入命令：

        docker exec -it centos2 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    interface    |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    eth0@if12    |   172.17.0.3/16    |  172.17.255.255 | 02:42:ac:11:00:03 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

  * 宿主机关闭容器 centos2，运行新的容器 centos3，再启动容器 centos2，输入命令：

        docker stop centos2

        docker run -it -d --name centos3 centos /usr/sbin/init

        docker start centos2

  * 宿主机查看容器 centos2、centos3 网络，可以看出，容器 IP 不是固定的，每次重启都可能会发生变化，输入命令：

        docker exec -it centos2 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    interface    |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    eth0@if17    |   172.17.0.4/16    |  172.17.255.255 | 02:42:ac:11:00:04 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker exec -it centos3 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    interface    |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    eth0@if15    |   172.17.0.3/16    |  172.17.255.255 | 02:42:ac:11:00:03 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

### 共享主机网络 host

  * 宿主机查看本机网络，输入命令：

        ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:8c:5b:ba:0a |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        可以看到宿主机有两个网卡，一个安装虚拟机自带的网卡 ens33，另一个安装 docker 自动配置的网卡 docker0

  * 运行两个 centos 容器，输入命令：

        docker pull centos

        docker run -it -d --net=host --name centos1 centos /usr/sbin/init

        docker run -it -d --net=host --name centos2 centos /usr/sbin/init

        docker ps

  * 宿主机查看 centos 容器网络，可以看出，容器共享了宿主机的网络，输入命令：

        docker exec -it centos1 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:8c:5b:ba:0a |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker exec -it centos2 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:8c:5b:ba:0a |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

  * 容器可以 ping 宿主机，输入命令：

        docker exec -it centos1 ping 192.168.140.201

        ->

            64 bytes from 192.168.140.201: icmp_seq=1 ttl=64 time=0.205 ms
            64 bytes from 192.168.140.201: icmp_seq=2 ttl=64 time=0.050 ms
            64 bytes from 192.168.140.201: icmp_seq=3 ttl=64 time=0.045 ms

            3 packets transmitted, 3 received, 0% packet loss, time 2000ms

  * 容器可以 ping 与宿主机同一局域网的主机，输入命令：

        docker exec -it centos1 ping 192.168.140.202

        ->

            64 bytes from 192.168.140.202: icmp_seq=1 ttl=63 time=0.981 ms
            64 bytes from 192.168.140.202: icmp_seq=2 ttl=63 time=0.308 ms
            64 bytes from 192.168.140.202: icmp_seq=3 ttl=63 time=0.283 ms

            3 packets transmitted, 3 received, 0% packet loss, time 2002ms

  * 容器可以 ping 宿主机能访问的互联网，输入命令：

        docker exec -it centos1 ping www.baidu.com

        ->

            64 bytes from 14.215.177.38 (14.215.177.38): icmp_seq=1 ttl=127 time=11.7 ms
            64 bytes from 14.215.177.38 (14.215.177.38): icmp_seq=2 ttl=127 time=10.3 ms
            64 bytes from 14.215.177.38 (14.215.177.38): icmp_seq=3 ttl=127 time=11.0 ms

            3 packets transmitted, 3 received, 0% packet loss, time 2004ms

  * 因为容器都使用宿主机的网卡，同一宿主机的容器访问可以使用 localhost，可以跨主机访问其他容器，这里不做测试

### 无网络模式 none

  * 宿主机查看本机网络，输入命令：

        ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:8c:5b:ba:0a |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        可以看到宿主机有两个网卡，一个安装虚拟机自带的网卡 ens33，另一个安装 docker 自动配置的网卡 docker0

  * 运行一个 centos 容器，输入命令：

        docker pull centos

        docker run -it -d --net=none --name centos centos /usr/sbin/init

        docker ps

  * 宿主机查看 centos 容器网络，输入命令：

        docker exec -it centos ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |     lo          |   127.0.0.1/8      |                 | 00:00:00:00:00:00 |      host      |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        可以看到容器内部只有一个本机回环网卡 lo

  * 除了 ping 自己，容器在此模式下网络完全断开，输入命令：

        docker exec -it centos ping 192.168.140.201

        -> connect: Network is unreachable

### 共享容器网络 container

  * 宿主机查看本机网络，输入命令：

        ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:8c:5b:ba:0a |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        可以看到宿主机有两个网卡，一个安装虚拟机自带的网卡 ens33，另一个安装 docker 自动配置的网卡 docker0

  * 运行一个使用 bridge 网络的 centos 容器，输入命令：

        docker pull centos

        docker run -it -d --name centos1 centos /usr/sbin/init

        docker ps

  * 运行一个使用 container 网络的 centos 容器，输入命令：

        docker run -it -d --net=container:centos1 --name centos2 centos /usr/sbin/init

        docker ps

  * 查看 centos 容器网络，输入命令：

        docker exec -it centos1 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   eth0@if14     |    172.17.0.2/16   |  172.17.255.255 | 02:42:ac:11:00:02 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        docker exec -it centos2 ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   eth0@if14     |    172.17.0.2/16   |  172.17.255.255 | 02:42:ac:11:00:02 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

  * 查看宿主机网络，输入命令：

        ip addr

        ->
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:8c:5b:ba:0a |      global    |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
        |vetha447bd8@if13 |                    |                 | 0e:a0:01:a8:ac:d2 |       link     |             |
        +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

        可以看到 centos2 容器共享了 centos1 容器网络

  * 与共享容器的网络模式对应，这里不做测试
