
# docker macvlan networks

    macvlan 通过直接连接到物理网络实现，效率高，但是官方不建议使用—虚拟网络应该与物理网络隔离

    macvlan 要求 linux 系统内核版本不低于 3.9，需要手动分配各个宿主机的容器IP地址范围，容器直接网络互通，容器无法直接连接宿主机

    macvlan 容器之间可以跨主机互相访问

#### macvlan

    两台 docker 宿主机，提前配置好 docker 运行环境：

      192.168.140.200

      192.168.140.201

    第一台宿主机创建 macvlan 网卡，并运行 centos 容器，输入命令：

      docker network create -d macvlan --subnet=10.100.0.0/16 --gateway=10.100.0.1 -o parent=ens33 macvlan

      docker run -d -it --net macvlan --ip 10.100.1.1 --name centos1 centos

      docker run -d -it --net macvlan --ip 10.100.1.2 --name centos2 centos

    第二台宿主机创建 macvlan 网卡，并运行 centos 容器，输入命令：

      docker network create -d macvlan --subnet=10.100.0.0/16 --gateway=10.100.0.1 -o parent=ens33 macvlan

      docker run -d -it --net macvlan --ip 10.100.2.1 --name centos1 centos

      docker run -d -it --net macvlan --ip 10.100.2.2 --name centos2 centos

    第一台宿主机查看本机和容器网络，输入命令：

      ip addr

      ->
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
          |  interface      |      ipv4          |       brd       |       mac         |      scope     |      master    |
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
          |    ens33        | 192.168.140.200/24 | 192.168.140.255 | 00:0c:29:d7:d4:c3 |      global    |                |
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
          |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:f3:32:c2:79 |      global    |                |
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+

      docker exec -it centos1 ip addr

      ->
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |   eth0@if2      |   10.100.1.1/16    | 10.100.255.255  | 02:42:0a:64:01:01 |      global    |             |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

      docker exec -it centos2 ip addr

      ->
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |   eth0@if2      |   10.100.1.2/16    | 10.100.255.255  | 02:42:0a:64:01:02 |      global    |             |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

      docker network inspect macvlan

      ->
          +-----------+------------------+-----------------+-------------------+----------------+-------------------+
          | Network   |      Subnet      |     Gateway     |     container     |   IPv4Address  |     MacAddress    |
          +-----------+------------------+-----------------+-------------------+----------------+-------------------+
          |           |                  |                 |      centos1      | 10.100.1.1/16  | 02:42:0a:64:01:01 |
          |  macvlan  |  10.100.0.0/16   |   10.100.0.1    +-------------------+----------------+-------------------+
          |           |                  |                 |      centos2      | 10.100.1.2/16  | 02:42:0a:64:01:02 |
          +-----------+------------------+-----------------+-------------------+----------------+-------------------+

    第二台宿主机查看本机和容器网络，输入命令：

      ip addr

      ->
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
          |  interface      |      ipv4          |       brd       |       mac         |      scope     |      master    |
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
          |    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |                |
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+
          |   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:9d:4a:ca:14 |      global    |                |
          +-----------------+--------------------+-----------------+-------------------+----------------+----------------+

      docker exec -it centos1 ip addr

      ->
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |   eth0@if2      |   10.100.2.1/16    | 10.100.255.255  | 02:42:0a:64:02:01 |      global    |             |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

      docker exec -it centos2 ip addr

      ->
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+
          |   eth0@if2      |   10.100.2.2/16    | 10.100.255.255  | 02:42:0a:64:02:02 |      global    |             |
          +-----------------+--------------------+-----------------+-------------------+----------------+-------------+

      docker network inspect macvlan

      ->
          +-----------+------------------+-----------------+-------------------+----------------+-------------------+
          | Network   |      Subnet      |     Gateway     |     container     |   IPv4Address  |     MacAddress    |
          +-----------+------------------+-----------------+-------------------+----------------+-------------------+
          |           |                  |                 |      centos1      | 10.100.2.1/16  | 02:42:0a:64:02:01 |
          |  macvlan  |  10.100.0.0/16   |   10.100.0.1    +-------------------+----------------+-------------------+
          |           |                  |                 |      centos2      | 10.100.2.2/16  | 02:42:0a:64:02:02 |
          +-----------+------------------+-----------------+-------------------+----------------+-------------------+

    容器可以 ping 本机容器，输入命令：

      docker exec -it centos1 ping 10.100.1.2

      ->

        PING 10.100.1.2 (10.100.1.2) 56(84) bytes of data.
        64 bytes from 10.100.1.2: icmp_seq=1 ttl=64 time=0.315 ms
        64 bytes from 10.100.1.2: icmp_seq=2 ttl=64 time=0.069 ms
        64 bytes from 10.100.1.2: icmp_seq=3 ttl=64 time=0.109 ms
        3 packets transmitted, 3 received, 0% packet loss, time 2030ms

    容器可以 ping 跨主机容器，输入命令：

      docker exec -it centos1 ping 10.100.2.1

      ->

        PING 10.100.2.1 (10.100.2.1) 56(84) bytes of data.
        64 bytes from 10.100.2.1: icmp_seq=1 ttl=64 time=0.418 ms
        64 bytes from 10.100.2.1: icmp_seq=2 ttl=64 time=0.347 ms
        64 bytes from 10.100.2.1: icmp_seq=3 ttl=64 time=0.458 ms
        3 packets transmitted, 3 received, 0% packet loss, time 2030ms

    容器不能 ping 宿主机，输入命令：

      docker exec -it centos1 ping 192.168.140.200

      ->

        PING 192.168.140.200 (192.168.140.200) 56(84) bytes of data.
        From 10.100.1.1 icmp_seq=1 Destination Host Unreachable
        From 10.100.1.1 icmp_seq=2 Destination Host Unreachable
        From 10.100.1.1 icmp_seq=3 Destination Host Unreachable
        5 packets transmitted, 0 received, +3 errors, 100% packet loss, time 4103ms

    以上，容器只能访问本机、跨主机容器，无法访问宿主机，外界也访问不到容器
