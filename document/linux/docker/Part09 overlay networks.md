
# docker overlay networks

	overlay模式，使用 docker network create -d overlay <NAME> 创建docker网卡，启动时加上 --net=<NAME> 参数

	overlay模式实现：基于 consul 的旧版本实现、基于 swarm 的新版本实现

	overlay模式，容器之间可以跨主机互相访问

#### 服务器准备

	192.168.140.200		#docker宿主机

	192.168.140.201		#docker宿主机

	192.168.140.202		#consul服务器

	(三台服务器根据 Part1 配置好 docker，并且内核版本不低于3.18)

#### 配置overlay环境

	consul服务器安装启动consul，输入命令：

		docker pull consul

		docker images

		docker run -d -p 8500:8500 --name consul consul

		docker ps

	客户端浏览器查看consul，输入地址：

		http://192.168.140.202:5800/

	两台宿主机输入命令：

		vi /etc/docker/daemon.json

		=>

			{
				"cluster-store": "consul://192.168.140.202:8500",
				"cluster-advertise": "ens33:2376"
			}

	两台宿主机重启 docker，输入命令：

		systemctl daemon-reload

		systemctl restart docker

	客户端浏览器查看 consul Key/Value 可以看到两个节点注册成功：

		192.168.140.201:2376

		192.168.140.200:2376

	一台宿主机创建 docker overlay network，输入命令：

		docker network create -d overlay my-overlay

	两台宿主机查看 docker network，输入命令：

		docker network ls

		->
		+--------------+------------------+---------+-------+
		|  NETWORK ID  |      NAME        |  DRIVER | SCOPE |
		+--------------+------------------+---------+-------+
		| 5217f2232b46 |  bridge          | bridge  | local |
		+--------------+------------------+---------+-------+
		| 1f514d9ef86b |  host            | host    | local |
		+--------------+------------------+---------+-------+
		| b020119e4d9e |  my-overlay      | overlay | global|
		+--------------+------------------+---------+-------+
		| 7c9f12689eb8 |  none            | null    | local |
		+--------------+------------------+---------+-------+
		
	至此配置完成

#### 容器网络

	第一台宿主机运行  centos 容器，输入命令：

		docker run -d -it --net my-overlay --name centos1 centos /usr/sbin/init

	第二台宿主机运行 centos 容器，输入命令：

		docker run -d -it --net my-overlay --name centos2 centos /usr/sbin/init

	两台宿主机查看网络信息，输入命令：

		ip addr

		-> 第一台宿主机输出信息：
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+
		|  interface      |      ipv4          |       brd       |       mac         |      scope     |      master    |
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+
		|    ens33        | 192.168.140.200/24 | 192.168.140.255 | 00:0c:29:d7:d4:c3 |      global    |                |
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+
		|   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:f5:1e:5b:5b |      global    |                |
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+
		| docker_gwbridge |   172.18.0.1/16    | 172.18.255.255  | 02:42:34:e4:88:b4 |      global    |                |
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+
		| vethe12d07b@if20|                    |                 | 1a:20:c5:6f:2b:ea |       link     |docker_gwbridge |
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+

		-> 第二台宿主机输出信息：
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+
		|  interface      |      ipv4          |       brd       |       mac         |      scope     |      master    |
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+
		|    ens33        | 192.168.140.201/24 | 192.168.140.255 | 00:0c:29:92:0a:f0 |      global    |                |
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+
		|   docker0       |   172.17.0.1/16    | 172.17.255.255  | 02:42:0e:15:fa:40 |      global    |                |
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+
		| docker_gwbridge |   172.18.0.1/16    | 172.18.255.255  | 02:42:2c:8c:7a:b1 |      global    |                |
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+
		| vethe12d07b@if43|                    |                 | 76:4f:e5:19:4a:69 |       link     |docker_gwbridge |
		+-----------------+--------------------+-----------------+-------------------+----------------+----------------+

	两台宿主机查看 centos 容器网络，输入命令：

		docker exec -it centos1 ip addr

		-> 第一台宿主机容器输出信息：
		+-----------------+--------------------+-----------------+-------------------+----------------+-------------+
		|  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
		+-----------------+--------------------+-----------------+-------------------+----------------+-------------+
		|   eth0@if19     |    10.0.0.2/24     |   10.0.0.255    | 02:42:0a:00:00:02 |      global    |             |
		+-----------------+--------------------+-----------------+-------------------+----------------+-------------+
		|   eth0@if21     |   172.18.0.2/16    | 172.18.255.255  | 02:42:ac:12:00:02 |      global    |             |
		+-----------------+--------------------+-----------------+-------------------+----------------+-------------+

		docker exec -it centos2 ip addr

		-> 第二台宿主机容器输出信息：
		+-----------------+--------------------+-----------------+-------------------+----------------+-------------+
		|  interface      |      ipv4          |       brd       |       mac         |      scope     |    master   |
		+-----------------+--------------------+-----------------+-------------------+----------------+-------------+
		|   eth0@if42     |    10.0.0.3/24     |   10.0.0.255    | 02:42:0a:00:00:03 |      global    |             |
		+-----------------+--------------------+-----------------+-------------------+----------------+-------------+
		|   eth0@if44     |   172.18.0.2/16    | 172.18.255.255  | 02:42:ac:12:00:02 |      global    |             |
		+-----------------+--------------------+-----------------+-------------------+----------------+-------------+

	两台宿主机查看 docker 网卡，输入命令：

		docker network ls

		-> 两台宿主机输出：
		+--------------+------------------+---------+-------+
		|  NETWORK ID  |      NAME        |  DRIVER | SCOPE |
		+--------------+------------------+---------+-------+
		| 5217f2232b46 |  bridge          | bridge  | local |
		+--------------+------------------+---------+-------+
		| c68a1d83cd49 |  docker_gwbridge | bridge  | local |
		+--------------+------------------+---------+-------+
		| 1f514d9ef86b |  host            | host    | local |
		+--------------+------------------+---------+-------+
		| b020119e4d9e |  my-overlay      | overlay | global|
		+--------------+------------------+---------+-------+
		| 7c9f12689eb8 |  none            | null    | local |
		+--------------+------------------+---------+-------+

		docker network inspect my-overlay

		-> 两台宿主机输出：
		+----------+------------------+-----------------+-------------------+----------------+-------------------+
		| Network  |      Subnet      |     Gateway     |     container     |   IPv4Address  |     MacAddress    |
		+----------+------------------+-----------------+-------------------+----------------+-------------------+
		|          |                  |                 |      centos1      |   10.0.0.2/24  | 02:42:0a:00:00:02 |
		|my-overlay|   10.0.0.0/24    |     10.0.0.1    +-------------------+----------------+-------------------+
		|          |                  |                 |      centos2      |   10.0.0.3/24  | 02:42:0a:00:00:03 |
		+----------+------------------+-----------------+-------------------+----------------+-------------------+

		docker network inspect docker_gwbridge

		-> 第一台宿主机输出：
		+---------------+------------------+-----------------+--------------------+----------------+-------------------+
		| Network       |      Subnet      |     Gateway     |     container      |   IPv4Address  |     MacAddress    |
		+---------------+------------------+-----------------+--------------------+----------------+-------------------+
		|docker_gwbridge|  172.18.0.0/16   |    172.18.0.1   |gateway_6f153690709d| 172.18.0.2/16  | 02:42:ac:12:00:02 |
		+---------------+------------------+-----------------+--------------------+----------------+-------------------+

		-> 第二台宿主机输出：
		+---------------+------------------+-----------------+--------------------+----------------+-------------------+
		| Network       |      Subnet      |     Gateway     |     container      |   IPv4Address  |     MacAddress    |
		+---------------+------------------+-----------------+--------------------+----------------+-------------------+
		|docker_gwbridge|  172.18.0.0/16   |    172.18.0.1   |gateway_381d8255c34d| 172.18.0.2/16  | 02:42:ac:12:00:02 |
		+---------------+------------------+-----------------+--------------------+----------------+-------------------+

	整理以上网络情况，可以梳理出网络连接信息：

		docker_gwbridge(172.18.0.1)  ----  vethe12d07b@if20(forward)  ----  eth1@if21(172.18.0.2)
		docker_gwbridge(172.18.0.1)  ----  veth685f01d@if43(forward)  ----  eth1@if44(172.18.0.2)

		my-overlay(10.0.0.1)  ----  eth0@if19(10.0.0.2)
		my-overlay(10.0.0.1)  ----  eth0@if42(10.0.0.3)

	容器 overlay 网络配置成功，两个容器的 overlay 网络 IP 地址分别为：10.0.0.2、10.0.0.3

#### 容器ping

	容器可以 ping 宿主机，输入命令：

		docker exec -it centos1 ping 192.168.140.200

		->

			64 bytes from 192.168.140.200: icmp_seq=1 ttl=64 time=0.162 ms
			64 bytes from 192.168.140.200: icmp_seq=2 ttl=64 time=0.047 ms
			64 bytes from 192.168.140.200: icmp_seq=3 ttl=64 time=0.061 ms

			3 packets transmitted, 3 received, 0% packet loss, time 2001ms

	容器可以 ping 与宿主机同一局域网的主机，输入命令：

		docker exec -it centos1 ping 192.168.140.201

		->

			64 bytes from 192.168.140.201: icmp_seq=1 ttl=63 time=0.775 ms
			64 bytes from 192.168.140.201: icmp_seq=2 ttl=63 time=0.297 ms
			64 bytes from 192.168.140.201: icmp_seq=3 ttl=63 time=0.476 ms

			3 packets transmitted, 3 received, 0% packet loss, time 2001ms

	容器可以 ping 宿主机能访问的互联网，输入命令：

		docker exec -it centos1 ping www.baidu.com

		->

			64 bytes from 14.215.177.38 (14.215.177.38): icmp_seq=1 ttl=127 time=12.9 ms
			64 bytes from 14.215.177.38 (14.215.177.38): icmp_seq=2 ttl=127 time=13.2 ms
			64 bytes from 14.215.177.38 (14.215.177.38): icmp_seq=3 ttl=127 time=9.26 ms

			3 packets transmitted, 3 received, 0% packet loss, time 2004ms

	容器可以 ping 跨主机容器，输入命令：

		docker exec -it centos1 ping 10.0.0.3

		->

			64 bytes from 10.0.0.3: icmp_seq=1 ttl=64 time=0.417 ms
			64 bytes from 10.0.0.3: icmp_seq=2 ttl=64 time=0.457 ms
			64 bytes from 10.0.0.3: icmp_seq=3 ttl=64 time=0.304 ms

			3 packets transmitted, 3 received, 0% packet loss, time 2007ms
